describe("Serve Letter", () => {
  beforeEach(() => {
  });
  it("Should create a new link based on a request", () => {
    cy.request(
      "https://us-central1-rumpelstiltskin-8cadf.cloudfunctions.net/testBed?type=wipeLink"
    ).then(() => {
      cy.wait(2000);
      cy.request(
        "https://us-central1-rumpelstiltskin-8cadf.cloudfunctions.net/testBed?type=getCrmLink"
      ).then((link) => {
        console.log(link.body.res);
        cy.wrap(JSON.parse(link.body).res).should("have.length", 0);
        cy.request(
          "POST",
          "https://firestore.googleapis.com/v1/projects/rumpelstiltskin-8cadf/databases/(default)/documents/requests?key=AIzaSyBBd8kYwZuOo6sXNwIxzZ380WQEGwuVPDI",
          {
            fields: {
              id: { integerValue: 61027 },
              table: { stringValue: "bmhvhc72c" },
              htmlField: { integerValue: 651 },
              linkField: { integerValue: 533 },
            },
          }
        ).then(() => {
          cy.wait(5000);
          cy.request(
            "https://us-central1-rumpelstiltskin-8cadf.cloudfunctions.net/testBed?type=getCrmLink"
          ).then((secondVal) => {
            console.log(secondVal.body);
            cy.wrap(JSON.parse(secondVal.body).res).should("have.length.gt", 1);
            cy.visit(`https://${JSON.parse(secondVal.body).res}`).then(() => {
              cy.get("body", { timeout: 5000 }).should("contain", "John");
            });
          });
        });
      });
    });
  });
});
