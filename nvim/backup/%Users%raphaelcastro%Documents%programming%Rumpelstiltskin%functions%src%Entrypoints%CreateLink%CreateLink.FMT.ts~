import {db} from '../../Shared/firestore'
import * as admin from 'firebase-admin'
import * as functions from "firebase-functions";
import { BuildWelcomeLetterReference } from "./CreateLink.LX";
import { quickbaseWrite } from "../../Shared/Quickbase";

/* <-- Import End --> */


/* <-- Variable Definition End --> */

export const createLink = functions.firestore
  .document("requests/{docId}")
  .onCreate(async (snap) => {
    return processAndArchiveRequest(snap)
  });

function processAndArchiveRequest(snap: any) {
  const {ref} = snap
  const data = snap.data()
  return db.runTransaction(async (transaction) => {
    const welcomeLetterRef = await BuildWelcomeLetterReference(data);
    await quickbaseWrite(welcomeLetterRef);
    const target = createRef(`ProcessedRequests/${snap.id}`);
    transaction.delete(ref);
    return transaction.create(target, formatOutput(data, welcomeLetterRef));
  });
}

function getTimestamp() {
  return admin.firestore.FieldValue.serverTimestamp();
}

function createRef(path: string) {
  const [collectionName, docName] = path.split("/");
  return db.collection(collectionName).doc(docName);
}

function formatOutput(data: any, welcomeLetterRef: any) {
  const time = getTimestamp();
  delete welcomeLetterRef.headers
  const output = {...data, result: welcomeLetterRef, time}
  console.log(output)
  return output;
}
